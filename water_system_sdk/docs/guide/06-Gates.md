# 第六章：水力控制结构 (1) - 闸门 (Gate)

欢迎来到大纲的第二部分！在接下来的几章中，我们将深入探讨构成水系统的各种核心物理组件。我们将从最常见的控制结构之一——闸门开始。

在之前的章节中，我们假设控制器的输出直接就是水库的入流。在现实世界中，流量是由物理结构（如闸门、水泵、阀门）控制的。本章将向您展示如何在 `chs-sdk` 中对一个由PID控制器控制的闸门进行建模，以维持上游水库的水位。

## 核心概念：一个更真实的控制回路

一个真实的控制系统不仅仅是 `控制器 -> 系统`。它包含一个完整的因果链：

1.  **传感器 (Sensor)**: 测量系统的状态（例如，水位）。真实传感器总是有噪声的。
2.  **控制器 (Controller)**: 读取传感器的值，并决定一个期望的执行器状态（例如，“将闸门开启到50%”）。
3.  **执行器 (Actuator)**: 接收控制器的指令并物理上移动设备。执行器有其自身的物理限制，比如移动需要时间。
4.  **物理结构 (Physical Structure)**: 执行器的状态（例如，闸门的实际开启度）会改变系统的物理行为（例如，通过闸门的流量）。

`chs-sdk` 为这个链条的每一个环节都提供了模型。

## 场景：用闸门控制水库水位

我们将构建一个系统，其中一个上游水源通过一个由PID控制器控制的双叶闸门站向我们的主水库供水。

*   **目标**: 将主水库的水位维持在 **10米**。
*   **控制方式**: 通过调整上游闸门的开启度来控制进入水库的流量。
*   **真实性**: 我们将考虑传感器噪声和闸门执行器的移动延迟。

## 构建仿真脚本

### 组件解释

*   `LevelSensor`: 模拟一个带有随机噪声的水位传感器。
*   `PIDController`: 我们已经熟悉的PID控制器，但这次它的输出是0-1之间的目标闸门开度。
*   `GateActuator`: 模拟闸门不会瞬间开启或关闭。它有 `travel_time` 参数，定义了从完全关闭到完全打开所需的时间。
*   `GateStationModel`: 根据上游水位、下游水位和实际的闸门开度，使用标准的闸门流量公式来计算通过的流量。

### 连接因果链

我们的仿真逻辑将遵循以下步骤：
1. `LevelSensor` 测量 `MyReservoir` 的真实水位，并加上一些噪声。
2. `PIDController` 读取 `LevelSensor` 的带噪信号，将其与设定值（10米）比较，然后输出一个目标闸门开度（0到1之间）。
3. `GateActuator` 接收到这个目标开度，并根据其 `travel_time` 随时间逐步改变其“实际开度”。
4. `GateStationModel` 使用 `GateActuator` 的“实际开度”以及上下游水位来计算真实的入库流量。
5. 这个流量最终进入 `MyReservoir`，改变其水位，从而形成一个完整的闭环。

## 完整脚本与运行

本章的完整示例代码已保存到以下文件中：

`source/ch06/ch06_gate_control.py`

您可以直接运行此文件来查看仿真结果：

```bash
python water_system_sdk/docs/guide/source/ch06/ch06_gate_control.py
```

### 预期结果

运行脚本后，您会看到一个包含两个子图的图表：
*   **上图** 显示了水库的“真实水位”和带噪声的“传感器水位”。您会看到真实水位如何平滑地接近10米的红色设定值线。
*   **下图** 展示了控制过程。您可以看到PID控制器发出的绿色虚线“目标开度”，以及由于物理限制而略有延迟的紫色实线“实际开度”。蓝色的流量曲线显示了闸门是如何根据开度来调节流量的。

这个例子完美地展示了如何将多个组件智能体链接在一起，以模拟一个更完整、更真实的控制系统。在下一章中，我们将探讨另一个关键组件：水泵。
