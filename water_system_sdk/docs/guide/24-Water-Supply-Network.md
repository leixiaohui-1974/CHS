# 第二十四章：场景实战 (2) - 城市供水管网

在灌区场景之后，我们来挑战一个更复杂的、完全基于 **有压管流** 的综合应用：**城市供水管网**。这个案例将把我们之前学过的有压系统组件——水库、水泵、水箱——串联起来，并应用多层控制逻辑，构建一个从水源到用户的完整供水仿真模型。

## 核心概念：多层级控制

真实的供水系统很少用单一的控制器来管理。更常见的是一个 **多层级 (Multi-level)** 或 **多目标 (Multi-objective)** 的控制系统。
*   **启停控制 (On/Off Control)**: 水泵等高能耗设备，通常采用简单的启停控制，以避免频繁启动造成损耗。其控制逻辑通常是基于高、低水位的阈值规则，这种控制方式也叫“滞回控制 (Hysteresis Control)”。
*   **调节控制 (Modulating Control)**: 阀门等精细调节设备，通常采用PID或MPC等连续控制算法，以精确地维持某个过程变量（如流量、压力）的稳定。

在本章的场景中，我们将聚焦于水泵的启停控制，这是供水调度中最核心的逻辑之一。

## 场景：从水源地到高架水箱

我们将搭建以下供水系统：
*   **水源地**: 一个低位水库 `SourceReservoir`。
*   **泵站**: `PumpStation` 从低位水库取水，并将其加压送往高处。
*   **高架水箱**: `ElevatedTank` 位于高处，负责向城市供水。
*   **用户需水**: 我们用一个变化的 `Demand` (时间序列扰动) 来模拟城市从高架水箱取水的过程。
*   **控制逻辑**:
    1.  当高架水箱水位低于52米时，开启水泵。
    2.  当水位高于58米时，关闭水泵。

*注意：为了简化并突出多层控制的概念，我们在这个程序化建模的例子中省略了水泵和水箱之间的长距离管道和调节阀门。一个更完整的模型（如此前提到的，最好用配置文件方式搭建）会包含这些组件，并需要处理更复杂的压力计算。*

## 构建仿真脚本

### 组件解释

*   `LinearTank`: 两个实例，分别代表低位水源和高位水箱。
*   `PumpStationModel`: 核心动力组件。
*   `TimeSeriesDisturbance`: 模拟城市用户需水。
*   **自定义控制逻辑**: 水泵的启停控制，我们将直接在主循环中用 `if/else` 语句实现，以清晰地展示其逻辑。

### 完整脚本与运行

本章的完整示例代码已保存到以下文件中：

`source/ch24/ch24_water_supply_network.py`

您可以直接运行此文件来查看仿真结果：

```bash
python water_system_sdk/docs/guide/source/ch24/ch24_water_supply_network.py
```

### 预期结果

运行脚本后，您会看到一个包含两个子图的图表：
*   **上图** 显示了高架水箱的水位变化（蓝线）。您会看到水位在52米（绿色虚线）和58米（红色虚线）之间波动。当水位触及下限时，水泵开启，水位上升；当水位触及上限时，水泵关闭，水位因城市用水而下降。
*   **下图** 显示了水泵的开关状态（紫色阶梯线）和城市需水量（青色虚线）。您可以清楚地看到水泵是如何根据水箱水位自动启停，以满足不断变化的城市用水需求的。

这个例子展示了如何将多个组件组合起来，并实施一个基础但非常实用的调度策略，以保证城市供水的可靠性。
