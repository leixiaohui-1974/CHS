# 第二十一章：调度 (2) - 优化调度

上一章我们学习了基于规则的调度，它将固定的专家知识转化为IF-THEN逻辑。但如果系统的目标是动态的，并且需要权衡多个目标（例如，在满足所有约束的同时，最大化发电效益或最小化供水成本），我们就需要一种更高级的调度方法：**优化调度**。

优化调度的核心思想，是将调度问题构建为一个数学 **优化问题**，然后用求解器找到“最优”的调度方案。`chs-sdk` 通过 **分层控制 (Hierarchical Control)** 的理念来支持这一点，其核心是 `DispatchAgent`。

## 核心概念：分层控制

在复杂系统中，将所有决策都交给一个庞大的中央控制器是低效且脆弱的。分层控制将决策分为两个层面：
1.  **战略层 (Strategic Layer)**: 由 `DispatchAgent` (调度智能体) 扮演。它拥有全局视野，负责制定长期的、宏观的系统目标。例如，“在未来24小时内，将A水库的水位从10米提升到15米”。它不关心具体如何实现，只负责下达这个“宏指令 (Macro-command)”。
2.  **战术层 (Tactical Layer)**: 由我们之前学过的 `PIDAgent` 或 `MPCAgent` 等控制器扮演。它们是“执行者”，负责接收来自战略层的宏指令，并将其转化为具体、实时的控制动作（如调节阀门开度），以确保宏观目标的达成。

这种“大脑”和“手”分离的架构，使得系统结构清晰，易于扩展和维护。

## 场景：中央调度中心协调双水库运行

我们将模拟以下场景，这是对 `scenarios/case_centralized_mpc` 的简化和程序化实现：
*   一个系统包含两个独立的水库 (`Tank1`, `Tank2`)，每个水库都有一个由 `PIDAgent` 控制的出口阀门。
*   一个中央的 `DispatchAgent` 负责监控两个水库的水位。
*   **调度逻辑**:
    1.  初始状态下，两个PID都将各自水库的水位维持在10米。
    2.  在仿真进行到一半时，`DispatchAgent` (大脑) 决定需要改变运行策略。它向 `Tank2` 的PID控制器发送一个宏指令，要求其将目标水位从10米 **提高到12米**。
*   **目标**: 观察 `DispatchAgent` 如何通过发送一个高层指令，来改变局部控制器的行为，从而实现对整个系统运行模式的调整。

## 构建调度脚本

### 组件解释

*   `DispatchAgent`: 战略层。在本例中，它的“优化逻辑”非常简单：在特定时间发送一个预设的指令。在实际应用中，它可以内嵌一个复杂的优化模型。
*   `PIDAgent`: 战术层。它会监听来自 `DispatchAgent` 的指令，并根据指令更新自己的 `setpoint`。
*   `LinearTank`, `ValveAgent`: 物理层，代表水库和阀门。

### 完整脚本与运行

本章的完整示例代码已保存到以下文件中：

`source/ch21/ch21_optimization_dispatch.py`

您可以直接运行此文件来查看仿真结果：

```bash
python water_system_sdk/docs/guide/source/ch21/ch21_optimization_dispatch.py
```

### 预期结果

运行脚本后，您会看到：
*   `Tank1` 的水位（蓝线）在整个仿真过程中，都稳定地保持在初始的10米。
*   `Tank2` 的水位（橙线）在开始时也稳定在10米。但在500秒时，由于 `DispatchAgent` 发送了新的指令，它的PID控制器接收到了新的12米目标。因此，`Tank2` 的水位开始上升，并最终稳定在12米。

这个例子清晰地展示了分层调度的概念：一个中央大脑负责“做什么”（改变目标），而底下的控制器负责“怎么做”（调节阀门以达到目标）。这是构建大型、智能水务系统的基础架构。
