# 第二十三章：场景实战 (1) - 灌区渠道水力调配

欢迎来到指南的第四部分！在这一部分，我们将不再学习新的独立组件，而是专注于如何将前面学到的知识融会贯通，搭建出更贴近真实世界的 **综合应用系统**。

我们的第一个实战场景，是模拟一个典型的 **灌区干渠配水系统**。我们将从上游水库放水，水流通过干渠输送，并由分水闸门引向支渠，实现对下游不同区域的按需配水。

## 核心概念：网络化建模

与之前线性的“A连接B，B连接C”模式不同，本章的重点在于构建一个有 **分支 (Branching)** 的网络拓扑。
1.  **节点与连接**: 我们需要更仔细地思考系统的连接关系。一个组件的输出，可以同时作为多个其他组件的输入（分流）；一个组件的输入，也可以接收来自多个其他组件的输出（合流）。
2.  **水量平衡**: 在网络中的任何一点，水量都应该是守恒的。例如，在分水闸门处，`干渠上游流量 = 闸门分走流量 + 干渠下游流量`。`chs-sdk` 的`Host`在后台处理了这些连接和计算，但我们需要正确地定义它们。
3.  **系统化思维**: 我们需要从单个组件的功能，转向思考整个系统的联动行为。上游一个闸门的微小调整，会如何通过渠道的延迟和衰减，影响到下游几十公里外的另一个用户的取水？这是系统化仿真的核心价值所在。

## 场景：干支渠配水系统

我们将用程序化建模的方式，搭建以下系统：
*   **水源**: 一个上游水库 (`UpstreamReservoir`)。
*   **输水干渠**: 一条5公里长的干渠 (`MainCanal`)，从水库引水。由一个渠首闸 (`HeadGate`) 控制。
*   **分水口**: 在干渠的末端，水分两路。
    *   一路通过 `BranchGate1` 进入支渠1 (`BranchCanal1`)，供给A灌区。
    *   另一路通过 `BranchGate2` 进入支渠2 (`BranchCanal2`)，供给B灌区。
*   **调度任务**:
    1.  首先，开启渠首闸，向干渠充水。
    2.  待干渠水流稳定后，在不同时间分别开启两个支渠的分水闸门，模拟按需供水。
*   **目标**: 观察整个系统的流量分配和演进过程。

## 构建仿真脚本

### 组件解释

*   `LinearTank`: 代表水源水库。
*   `GateModel`: 用于渠首闸和两个分水闸。
*   `MuskingumChannelModel`: 我们将用三个马斯京根模型实例，分别代表干渠、支渠1和支渠2。

### 完整脚本与运行

本章的完整示例代码已保存到以下文件中：

`source/ch23_irrigation_system.py`

您可以直接运行此文件来查看仿真结果：

```bash
python source/ch23_irrigation_system.py
```
*注意：为了简化，此示例中的连接方式做了一定的理想化处理。例如，它没有使用一个严格满足水量平衡的节点模型来处理分流。一个更精确的模型会使用`StVenantModel`中的节点或一个专门的`Junction`智能体。*

### 预期结果

运行脚本后，您会看到一个显示三条流量过程线的图表：
1.  **干渠出口流量**: 在10分钟渠首闸开启后，流量会因为马斯京根模型的演算而缓慢上升。当支渠闸门开启分水后，干渠的出口流量会相应减小。
2.  **支渠1 出口流量**: 在3小时之前，流量为0。在3小时闸门开启后，流量开始出现，并经过其自身的演算后流出。
3.  **支渠2 出口流量**: 在4小时之前，流量为0。在4小时闸门开启后，流量开始出现。

这个例子综合了我们之前学过的多个模块，并首次搭建了一个网络状的系统，是迈向更复杂应用场景的重要一步。
