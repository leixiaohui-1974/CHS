# 第十六章：核心业务流程 (1) - 数据预处理与清洗

欢迎来到指南的第三部分！在这一部分，我们将从对单个物理组件的关注，转向模拟一个完整水务项目所需的、更宏观的 **业务流程**。我们将要学习的第一个，也是在任何实际项目中都至关重要的一步，就是 **数据预处理与清洗**。

真实世界的数据很少是完美的。从传感器采集到的时间序列数据（如水位、流量、降雨量）往往包含缺失值、异常值（噪声）或者单位不一致等问题。在将这些数据输入到我们的仿真模型之前，必须对它们进行清洗和转换。`chs-sdk` 为此提供了强大而灵活的 **数据处理管道 (`Pipeline`)**。

## 核心概念：处理管道 (Pipeline)

`chs-sdk` 的数据预处理功能是围绕 `Pipeline` 对象构建的。
1.  **处理器 (Processor)**: 每个处理器都是一个独立的工具，负责执行一项具体的数据处理任务，例如 `DataCleaner` (数据清洗), `UnitConverter` (单位转换), `TimeResampler` (时间重采样) 等。
2.  **管道 (Pipeline)**: `Pipeline` 对象是一个容器，你可以将多个“处理器”按顺序放入其中。当数据进入管道时，它会像在流水线上一样，依次通过每个处理器进行加工，最终输出处理完毕的干净数据。

这种设计的优势在于，你可以将复杂的数据处理流程，拆解成一系列可复用、可自由组合的简单步骤。

## 场景：清洗一份降雨时间序列数据

我们将模拟一个非常常见的场景：
*   我们从一个气象站获得了一份降雨数据，但其中有几个小时的数据丢失了（表现为 `NaN` 值）。
*   此外，这份数据的单位是 **英寸 (inches)**，而我们的水文模型需要 **毫米 (mm)**。
*   **目标**: 构建一个处理管道，该管道能自动完成 **“填充缺失值”** 和 **“单位转换”** 这两个步骤。

## 构建处理脚本

### 组件解释

*   `pandas.DataFrame`: 我们将使用强大的 `pandas` 库来创建和操作我们的时间序列数据。`chs-sdk` 的数据处理工具与 `pandas` 无缝集成。
*   `DataCleaner`: 我们将用它来填充缺失值。它支持多种策略，如 `ffill` (用前一个有效值填充) 或 `mean` (用均值填充)。
*   `UnitConverter`: 我们将用它来完成单位转换。从英寸到毫米的转换系数是 **25.4**。
*   `Pipeline`: 我们将创建一个管道，并按 `DataCleaner` -> `UnitConverter` 的顺序将处理器放入其中。

### 完整脚本与运行

本章的完整示例代码已保存到以下文件中：

`source/ch16_data_preprocessing.py`

您可以直接运行此文件来查看仿真结果：

```bash
python source/ch16_data_preprocessing.py
```

### 预期结果

运行脚本后，您会在命令行看到：
*   **原始数据**，其中 `Rainfall_in` 列在第2和第5行有 `NaN` 值。
*   **处理后的数据**，其中：
    *   `Rainfall_mm` 列的缺失值已被填充（第2行的值变成了0.5，第5行的值变成了0.8）。
    *   `Rainfall_mm` 列的所有值都乘以了25.4，完成了单位转换。
    *   `Temperature_F` 列因为没有在 `UnitConverter` 中指定，所以保持不变。

本章展示了如何使用 `Pipeline` 来创建一个可重复、模块化的数据预处理工作流。在处理来自不同来源、质量不一的输入数据时，这是一个至关重要的第一步。
