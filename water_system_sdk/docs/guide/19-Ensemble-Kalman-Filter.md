# 第十九章：状态估计与数据同化 (2) - 集合卡尔曼滤波 (EnKF)

在上一章，我们学习了标准的卡尔曼滤波，它在处理线性系统时表现出色。但现实世界中的许多水系统模型，例如我们之前接触过的圣维南方程，都是高度 **非线性** 的。对于这些系统，标准卡尔曼滤波的线性假设不再成立，性能会急剧下降。

为了解决这个问题，`chs-sdk` 提供了更高级的数据同化方法，其中最重要的一种就是 **集合卡尔曼滤波 (Ensemble Kalman Filter, EnKF)**。

## 核心概念：EnKF 与“集合”思想

EnKF 的核心思想非常巧妙，它绕过了标准KF中复杂的协方差矩阵计算，转而使用一种基于 **蒙特卡洛方法** 的“集合”来近似。

1.  **集合 (Ensemble)**: EnKF 不是只维护一个状态估计，而是同时维护一个包含多个（例如50个）状态估计的“集合”。每个集合成员都被称为一个“粒子 (particle)”。这个集合的分布（均值和离散程度）就代表了我们对系统真实状态的估计和其不确定性。
2.  **预测 (Predict)**: 在预测步骤中，EnKF 会让 **每一个** 集合成员都独立地通过非线性模型向前演进。这样，集合的分布会自然地随着非线性动力学而演化。
3.  **更新 (Update)**: 当获得一个新的测量值时，EnKF 会计算一个卡尔曼增益，然后用它来分别修正 **每一个** 集合成员。那些离测量值较远的成员会被“拉”得更近一些。最终，更新后的集合分布就代表了融合了测量信息后的新状态估计。

EnKF 的巨大优势在于它 **不需要对模型进行线性化**，也 **不需要计算复杂的雅可比矩阵**，因此可以直接应用于任何复杂的非线性“黑箱”模型。

## 场景：追踪一个非线性系统的状态

为了专注于EnKF本身，我们将使用一个极简的非线性系统作为例子，而不是一个完整的水利模型。
*   **“真实”系统**: 系统的状态 `x` 随时间变化，而我们能观测到的量 `y` 是状态的非线性函数，`y = x²`。
*   **“模型”**: 我们有一个不完美的模型来描述状态 `x` 的变化。
*   **“传感器”**: 我们可以测量 `y`，但测量值有噪声。
*   **目标**: 使用EnKF，通过带噪声的 `y` 的测量值，来准确地追踪我们无法直接看到的、真实的状态 `x`。

## 构建辨识脚本

### 完整脚本与运行

本章的完整示例代码已保存到以下文件中：

`source/ch19/ch19_enkf_simulation.py`

您可以直接运行此文件来查看仿真结果：

```bash
python water_system_sdk/docs/guide/source/ch19/ch19_enkf_simulation.py
```

### 预期结果

运行脚本后，您会看到：
*   **上图** 显示了我们想要估计的真实状态 `x`（蓝线）和EnKF给出的估计值（绿虚线）。您会看到，尽管EnKF从未直接“看到”`x`，但它通过非线性的观测 `y`，成功地、准确地追踪了 `x` 的变化。
*   **下图** 显示了真实的 `y` 值（`x`的平方，蓝线）和我们提供给滤波器的、带噪声的测量值（黑点）。

这个例子清晰地展示了EnKF如何处理非线性问题。在实际的水务模型中，`f(x)` 将会是运行一步水力/水文模型，而 `h(x)` 则是从模型输出的完整状态中，提取出与传感器测量值相对应的部分（例如，某个特定断面的水位）。
