# 第二十八章：场景实战 (6) - 有压无压混合调水工程

欢迎来到第四部分的终极挑战。在本章中，我们将要模拟一种在现实世界中非常常见，但在技术上极具挑战性的系统：**有压-无压混合输水系统**。大型调水工程，如南水北调，常常需要通过压力管道（如隧洞）穿越山脉，然后再进入平原地区的明渠进行输送。

模拟这种系统的难点在于处理 **两种不同流态模型的交界面 (Interface)**。`chs-sdk` 的模块化设计允许我们通过在仿真循环中手动传递状态变量，来灵活地连接 `PipelineModel` (有压) 和 `StVenantModel` (无压)。

## 核心概念：模型耦合

1.  **状态变量传递**: 这是实现模型耦合的关键。我们需要在每个时间步：
    *   将有压管道模型计算出的 **流量**，作为明渠模型上游的 **入流边界**。
    *   将明渠模型计算出的入口端 **水位**，作为有压管道模型的 **出口压力**。
2.  **手动仿真循环**: 由于这种复杂的、双向的信息传递，我们无法再简单地使用 `host.add_connection`。我们需要回到一个手动的 `for` 循环中，在每个时间步显式地调用每个模型的 `step` 方法，并手动完成上述的状态变量传递。这展示了 `chs-sdk` 底层模型的灵活性和可组合性。

## 场景：压力隧洞向明渠的衔接

我们将模拟一个简化的南水北调式场景：
*   **水源**: 一个高位水库，提供100米的恒定上游压力。
*   **压力段**: 一条长5公里的压力管道 `Pipeline`，模拟穿山隧洞。
*   **控制阀**: 在管道末端有一个 `Valve`，用于调节出流量。
*   **衔接点**: 管道的出流，直接泄入一段明渠的渠首。
*   **无压段**: 一条10公里长的明渠 `Channel`，用 `StVenantModel` 模拟。
*   **目标**: 使用PID控制器调节阀门，使得明渠入口的流量稳定在目标值20 m³/s，并观察整个混合系统的动态响应。

## 构建仿真脚本

### 组件解释

*   `PipelineModel`: 模拟压力隧洞。
*   `ButterflyValve`: 控制管道出口流量。
*   `StVenantModel`: 模拟下游的明渠。
*   `PIDAgent`: 接收明渠入口的流量作为测量值，输出阀门开度指令。

### 完整脚本与运行

本章的完整示例代码已保存到以下文件中：

`source/ch28/ch28_hybrid_system.py`

您可以直接运行此文件来查看仿真结果：

```bash
python water_system_sdk/docs/guide/source/ch28/ch28_hybrid_system.py
```

### 预期结果

运行脚本后，您会看到：
*   **流量图**: 管道和渠道入口的流量在PID的控制下，逐渐稳定在20 m³/s的目标值。
*   **水位/开度图**: 渠道入口的水位会因为入流的增加而上涨，这会反过来影响阀门的压差，导致PID需要不断调整阀门的开度来维持恒定的流量。

这个终极案例展示了 `chs-sdk` 的灵活性。虽然我们推荐在可能的情况下使用 `Host` 或配置驱动的方式，但对于需要复杂自定义连接的系统，直接调用底层模型的 `step` 方法，并在Python循环中手动“接线”，为您提供了无限的可能性。

至此，我们完成了所有核心组件和典型应用场景的学习。恭喜您！
