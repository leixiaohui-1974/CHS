# 第十八章：状态估计与数据同化 (1) - 卡尔曼滤波

到目前为止，我们的模型和现实世界是“脱节”的。我们运行一个仿真，得到一个结果，但这个仿真过程是“开环”的——它不知道在真实世界中正在发生什么。如果模型的参数不准，或者有未知的扰动，模型的预测就会与现实越差越远。

本章，我们将学习如何将 **模型预测** 与 **传感器观测** 融合起来，得到比任何单一来源都更准确的系统状态估计。这个过程称为 **数据同化 (Data Assimilation)**，而 **卡尔曼滤波 (Kalman Filter)** 是实现它最经典、最强大的工具之一。

## 核心概念：卡尔曼滤波

想象一下，你有两个关于系统状态（比如水库水位）的信息来源：
1.  **模型预测**: 你的仿真模型根据上一时刻的状态和当前的输入，预测出当前的水位。这个预测有一定的不确定性（因为模型不完美），我们称之为 **过程噪声 (Process Noise)**。
2.  **传感器测量**: 你有一个水位计，直接测量当前的水位。这个测量也有不确定性（因为传感器有误差），我们称之为 **测量噪声 (Measurement Noise)**。

卡尔曼滤波器的作用，就是作为一个智能的“融合器”。它根据模型和传感器的不确定性（噪声）大小，来决定更“相信”谁。
*   如果模型很准而传感器很差，它就更相信模型预测。
*   如果传感器很准而模型很差，它就更相信传感器测量。

通过这种方式，它能在每个时间步都给出一个最优的、修正过的状态估计。这个过程包含两个步骤：
*   **预测 (Predict)**: 模型向前推算一步，得到一个预测值和其不确定性。
*   **更新 (Update)**: 用新的传感器测量值来“修正”这个预测，得到一个更精确的最终估计值。

## 场景：修正一个不准确的水库模型

我们将模拟以下场景：
*   我们有一个“真实”的水库，其水面面积为 1000 m²。
*   我们用来仿真的数字孪生模型是不完美的——我们错误地以为它的水面面积只有 800 m²。
*   我们有一个水位传感器，但它的读数有噪声。
*   **目标**: 使用卡尔曼滤波器，将带噪声的传感器读数，融合到不完美的模型中，看看是否能得到一个更接近真实水位的高保真状态估计。

## 构建辨识脚本

### 组件解释

*   `LinearTank`: 我们将用两个实例。一个代表“真实世界”，一个代表我们“不完美的数字孪生模型”。
*   `KalmanFilter`: 本章的核心。我们需要为其配置状态转移矩阵 `F`、观测矩阵 `H`、过程噪声 `Q` 和测量噪声 `R`。对于一个简单的水位模型，这些矩阵通常非常简单。

### 完整脚本与运行

本章的完整示例代码已保存到以下文件中：

`source/ch18_kalman_filter.py`

您可以直接运行此文件来查看仿真结果：

```bash
python source/ch18_kalman_filter.py
```

### 预期结果

运行脚本后，您会看到一个包含四条线和一堆散点的图表：
*   **真实水位 (蓝线)**: 这是我们想要追踪的“真相”。
*   **开环模型预测 (红虚线)**: 由于模型参数不准（面积设小了），它的水位上涨速度比真实情况快，与真相逐渐偏离。
*   **带噪声的测量值 (黑点)**: 这些点围绕在真实水位上下波动，代表了不精确的传感器读数。
*   **卡尔曼滤波修正后的水位 (绿线)**: 这是最关键的结果。您会看到这条线完美地融合了红色虚线和黑色散点的信息，它既不像开环模型那样持续偏离，也不像传感器读数那样剧烈波动，而是平滑、准确地追踪着蓝色的真实水位。

这个例子生动地展示了卡尔曼滤波的威力，它是构建能够响应现实、自我校正的“活”的数字孪生系统的关键。
