# 第二十七章：场景实战 (5) - 流域洪水预报与防洪调度

我们即将进入本指南中最复杂、也最接近真实水务决策的综合场景之一：**流域洪水预报与防洪调度**。这个案例将之前章节中的水文模型、水库、闸门、河道以及规则调度等知识全部融合在一起，模拟一个完整的“预报-预警-决策-调度”的业务闭环。

## 核心概念：预报调度 (Forecast-Informed Dispatch)

在之前的调度场景中，我们的决策规则都是基于 **当前** 的系统状态（例如，“当前”水位高于xx）。但在防洪等需要未雨绸缪的场景中，这远远不够。我们必须根据对 **未来** 的预测来做出 **预操作**。这就是预报调度的核心思想。

1.  **预报 (Forecast)**: 在降雨实际发生或洪水实际到达之前，使用水文模型（如第十四章的`Basin`模型）和降雨预报数据，来模拟“假如我们什么都不做，未来几个小时（或几天）的天然洪水过程会是怎样？”。
2.  **决策 (Decision)**: 将预报得到的洪水过程（例如，未来入库流量将达到多大的洪峰）作为输入，提供给调度决策模型（例如，我们第二十章的`RuleBasedOperationalController`）。
3.  **预调度 (Proactive Dispatch)**: 决策模型根据预报信息和调度规则，下达 **预泄、蓄洪、错峰** 等操作指令。例如，“预报显示6小时后将有特大洪峰入库，现在立即开闸预泄，腾出库容”。

## 场景：水库防洪调度

我们将模拟以下场景：
*   **流域系统**: 一个上游汇水区，其径流汇入一个防洪任务重大的水库。水库下游是一段需要保护的河道。
*   **预报信息**: 我们获得了一份未来24小时的降雨预报。
*   **调度任务**:
    1.  **预报阶段**: 首先，单独运行上游汇水区的水文模型，得到未来24小时的“天然”入库洪水过程线。
    2.  **调度阶段**: 运行包含水库和下游河道的完整系统模型。水库的泄洪闸由一个规则控制器管理，该控制器的规则 **同时依赖于水库当前的水位和预报的未来洪峰信息**。
*   **目标**: 观察通过预报调度，水库如何成功地在保证自身安全的前提下，大幅削减下游河道的洪峰流量，实现防洪目标。

## 构建仿真脚本

由于该场景的复杂性，我们将重点解释其概念和伪代码实现。完整的、可运行的代码将包含在示例文件中。

### 脚本逻辑

1.  **加载水文模型配置**: 像第十四章一样，为上游汇水区定义 `topology`, `parameters` 和 `timeseries` (使用预报的降雨)。
2.  **运行预报模型**: 创建一个 `Basin` 对象并运行 `run_simulation()`，得到 `forecasted_inflow` 数组。
3.  **构建完整系统 (Host模式)**:
    *   创建一个 `Host`。
    *   创建 `Reservoir`, `Gate`, `DownstreamReach` 等智能体。
    *   创建一个 `RuleBasedOperationalController`。
4.  **定义预报调度规则**:
    ```python
    # 规则示例
    rules = [
        # 规则1：预报未来有大洪水，且水库有预泄空间
        {
            "if": [
                {"variable": "forecast.peak_inflow", "operator": ">", "value": 500},
                {"variable": "Reservoir.level", "operator": "<", "value": 19.5}
            ],
            "then": {"gate_opening": 0.3} # 提前预泄
        },
        # 规则2：水库超汛限水位
        {
            "if": [{"variable": "Reservoir.level", "operator": ">", "value": 20.0}],
            "then": {"gate_opening": 0.8} # 强力泄洪
        }
    ]
    ```
5.  **运行调度仿真**:
    *   在主循环中，不仅要更新各组件的状态，还需要将预报信息（如 `forecasted_inflow` 的峰值）动态地传递给规则控制器。
    *   `dispatcher.step(system_state={"Reservoir.level": ..., "forecast.peak_inflow": ...})`

### 完整脚本与运行

本章的完整示例代码（包含3个JSON文件和1个Python脚本）已保存到 `source` 目录下。

您可以直接运行主脚本来查看仿真结果：

```bash
python source/ch27_flood_control.py
```

### 预期结果

运行脚本后，您会看到一张包含两条流量过程线的对比图：
*   **天然入流 (预报)**: 如果没有水库，将会形成的巨大、尖锐的洪水波。
*   **水库下泄流量 (调度后)**: 经过水库的预泄和调蓄，实际下泄的流量过程线变得非常平缓，洪峰被显著“削平”，从而保护了下游地区的安全。

这个案例充分展示了 `chs-sdk` 如何将不同的模型（水文、水力）和决策逻辑（规则调度）结合起来，解决一个复杂、真实且极具价值的水务问题。
