# 第二十章：调度 (1) - 基于规则的调度

欢迎来到本指南的又一个重要概念——**调度 (Dispatch)**。在前面的章节中，我们学习的“控制”（如PID/MPC）主要关注于如何精确地、稳定地维持一个 **设定值 (Setpoint)**。而“调度”则是一个更宏观、更上层的概念，它决定了 **在什么时机、根据什么条件，应该执行什么操作**，或者 **应该将设定值调整为多少**。

最常见、最直观的调度方式就是 **基于规则的调度 (Rule-Based Dispatch)**。这种方法将专家的经验和操作规程，转化为一系列明确的 “如果...那么... (IF...THEN...)” 规则。`chs-sdk` 为此提供了 `RuleBasedOperationalController`。

## 核心概念：规则引擎

`RuleBasedOperationalController` 的工作方式类似于一个简单的规则引擎：
1.  **规则 (Rules)**: 你可以定义一个规则列表。每个规则都包含一个 **条件 (IF)** 和一个 **动作 (THEN)**。
2.  **条件 (IF)**: 条件部分可以由一个或多个逻辑判断组成，例如 `水位 > 15.0` 或 `入流 > 100`。
3.  **动作 (THEN)**: 动作部分定义了当条件满足时，控制器应该输出什么指令，例如，`{"闸门开度": 1.0, "水泵状态": 0}`。
4.  **默认动作 (Default Actions)**: 你还可以定义一个默认动作集。当 **所有** 规则的条件都不满足时，控制器将输出这个默认动作。这确保了系统在任何时候都有明确的指令。
5.  **执行**: 在每个时间步，控制器会按顺序检查所有规则。第一个被满足的规则将被触发，其对应的动作将被执行，然后控制器将不再检查后续的规则。

## 场景：水库防洪与兴利调度

我们将模拟一个经典的水库调度场景：
*   一个水库，有上游来水，并通过一个闸门和一个水泵向下游放水。
*   **调度规则**:
    1.  **防洪规则**: 如果水位超过汛限水位（比如15米），则 **关闭进水闸门** 并 **开启泄洪泵**，以快速降低水位。
    2.  **兴利规则**: 如果水位低于兴利水位（比如3米），则 **完全开启进水闸门** 并 **关闭水泵**，以快速蓄水。
    3.  **默认工况**: 如果水位在正常范围内，则保持 **进水闸门半开** 并 **关闭水泵**，进行常规运行。

## 构建调度脚本

### 组件解释

*   `LinearTank`: 代表我们的水库。
*   `GateModel`: 代表上游的进水闸门。
*   `PumpStationModel`: 代表下游的泄洪泵。
*   `RuleBasedOperationalController`: 本章的核心，用于实现上述调度逻辑。

### 完整脚本与运行

本章的完整示例代码已保存到以下文件中：

`source/ch20_rule_based_dispatch.py`

您可以直接运行此文件来查看仿真结果：

```bash
python source/ch20_rule_based_dispatch.py
```

### 预期结果

运行脚本后，您会看到：
*   **上图** 显示了水库水位的变化。在模拟开始时，由于上游洪水输入，水位会不断上涨。当水位超过15米的红色汛限水位线时，调度规则被触发。
*   **下图** 显示了调度指令的变化。当水位超过15米时，您会看到“闸门开度”指令立刻变为0（关闸），同时“水泵开关”指令变为1（开泵），这使得水位开始下降。当水位回到安全范围后，指令会恢复到默认值。

本章我们学习了如何用 `RuleBasedOperationalController` 将专家的调度知识和操作规程转化为可以自动执行的仿真逻辑。这是从简单的自动控制迈向更高级的自主决策支持系统的重要一步。
